<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Interplanetary Flirtation Device - Chloê Langford</title>
		<meta charset="utf-8">
		<link rel="icon" href="images/snail_small.png" type="image/png"> 
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />         
		<meta name="description" content="A device for communicating via touch with extraterrestrial beings. Using a snail as an interface, the user can encode their messages to aliens in taps, pinches, presses and swipes.">         
		<meta name="author" content="Chloê Langford">         
		<meta name="viewport" content="width=device-width, initial-scale=1.0">        
		<meta name="keywords" content="experimental art, media art, digital art, new media, net art, artgames, videogame, indie games, alien, extraterrestrial, Chloê Langford, tactile, mobile games, web-based art, snail, digital culture">        
		<!-- Twitter Card data -->         
		<meta name="twitter:card" content="summary">        
		<meta name="twitter:site" content="@greenred123">         
		<meta name="twitter:title" content="Interplanetary Flirtation Device v2.0">         
		<meta name="twitter:description" content="A device for communicating via touch with extraterrestrial beings. Using a snail as an interface, the user can encode their messages to aliens in taps, pinches, presses and swipes.">                 
		<meta name="twitter:creator" content="@greenred123">        
		<!-- Twitter Summary card images must be at least 120x120px -->         
		<meta name="twitter:image" content="https://ifd.co-ordinat.es/images/snail.jpg">         
		<!-- Open Graph data -->         
		<meta property="og:title" content="Interplanetary Flirtation Device" />         
		<meta property="og:type" content="article" />         
		<meta property="og:url" content="https://ifd.co-ordinat.es/" />         
		<meta property="og:image" content="https://ifd.co-ordinat.es/images/snail.jpg" />         
		<meta property="og:description" content="A device for communicating via touch with extraterrestrial beings. Using a snail as an interface, the user can encode their messages to aliens in taps, pinches, presses and swipes.">                 
		<meta property="og:site_name" content="Interplanetary Flirtation Device" />
		<style>
			body {
				color: #222;
			}

			a {
				color: #2fa1d6;
			}
êê
			p {
				max-width: 600px;
				margin-left: auto;
				margin-right: auto;
				padding: 0 2em;
			}
		</style>
	</head>

	<body style="margin:0; padding: 0;">
		<!-- <button id="button">debug</button> -->
		<!-- <a href="files/a-flipper-strokes.pdf" target="_blank">download test</a> -->
        <div id="container" style="margin:0; padding: 0;"></div>

        <div style="position: absolute; bottom: 10%; width: 100%; text-align: center;"><button><</button><button>+</button><button>-</button><button>></button></div>
        <script src="lib/hammerjs/hammer.min.js"></script>

		<script type="module">

			import * as THREE from './lib/three.module.js';

			import Stats from './lib/stats.module.js';
			import { GUI } from './lib/dat.gui.module.js';

            import { GLTFLoader } from './lib/GLTFLoader.js';
            import { OrbitControls } from './lib/OrbitControls.js';
            

			var container, stats, clock, gui, mixer, actions, activeAction, previousAction, startElement;
			var camera, scene, renderer, sceneParts, face, controls, raycastTarget, raycaster, audioTest;

			var currentDropdownSelection = { state: 'idle' };
			
			var state = 0;
			var previousState = 0;
			var stateCounter = 0;
			var interactionAnimations = {
				"panend": ["shudder", "move_head_up", "antennae_twich", "tail_thump", "antennae_twich", "tail_thump"],
				"swipe": ["cramp", "cramp", "shudder", "antennae_twitch", "dance"],
				"tap": ["antennae-twitch", "tail_thump", "antennae-twitch", "tail_thump", "cramp"], 
				"doubletap": ["antennae-twitch", "tail_thump", "tail_thump", "cramp", "bend_slightly_forward"],
				"pinchend": ["tail_thump", "move_head_up", "shudder", "cramp"], 
				"press": ["bend_slightly_forward", "tail_thump", "antennae_twitch"]
			};

			var stateIdleAnimations =  [
				["idle"], //state 0
				["antennae-twitch", "tail_wag"], //state 1
				["shudder", "dance"], //state 2
				["convulse"] //state 3
			];
			var stateEffects = [
				[], // state 0
				[], // state 1
				[], // state 2
				[] // state 3
			];
			var interactionPoints = {
				"panend": 3,
				"swipe": 5,
				"tap": 1, 
				"doubletap": 2,
				"pinchend": 3, 
				"press": 2
			}


			init();
            animate();
            addTouchEventListeners();

			function init() {

				audioTest = new Audio('audio/snarl.mp3');

				container = document.getElementById('container');

				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.25, 100 );
				camera.position.set( -0.923, 0.5, 5.52 );
                

				scene = new THREE.Scene();
				var texture = new THREE.TextureLoader().load( "models/gradient-orange-green.png" );
				scene.background = texture;

				clock = new THREE.Clock();

				// lights

				var light = new THREE.HemisphereLight( 0xffffff, 0x444444 );
				light.position.set( 0, 20, 0 );
				scene.add( light );

				light = new THREE.DirectionalLight( 0xffffff, 0.5);
				light.position.set( 0, 20, 10 );
				scene.add( light );


				var loader = new GLTFLoader();
				loader.load( 'models/snail_ani.glb', function ( gltf ) {

					sceneParts = gltf.scene;
                    scene.add( sceneParts );
					raycastTarget = sceneParts['children'][4];
					raycastTarget.material.transparent = true;
					raycastTarget.material.opacity = 0.2;

                    // console.log(raycastTarget);
                    // console.log(gltf.animations)

					createGUI( sceneParts, gltf.animations );
				}, undefined, function ( e ) {
					console.error( e );
				} );


                raycaster = new THREE.Raycaster();

				renderer = new THREE.WebGLRenderer( { antialias: true } );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.outputEncoding = THREE.sRGBEncoding;
                container.appendChild( renderer.domElement );
                
                controls = new OrbitControls(camera, renderer.domElement);
                controls.update();

				window.addEventListener( 'resize', onWindowResize, false );
				// document.getElementById("button").addEventListener('click', printOut);

				// stats
				// stats = new Stats();
				// container.appendChild( stats.dom );
			}

			function evaluateState() {
				if(stateCounter < 61) {
					state = 0;
				} else if (stateCounter < 121) {
					state = 1;
				} else if (stateCounter < 181) {
					state = 2;
				} else {
					state = 3;
				}
			}

			function createGUI( sceneParts, animations ) {

				var states = [ 
					'cramp',
					'antennae-twitch',
					'bend-slightly-forward',
					'convulse', 
					'dance', 
					'idle', 
					'move_head_up', 
					'shudder', 
					'tail_thump', 
					'tail_wag'
				 ];

				gui = new GUI();

				mixer = new THREE.AnimationMixer( sceneParts );

				actions = {};

				for ( var i = 0; i < animations.length; i ++ ) {

					var clip = animations[ i ];
					var action = mixer.clipAction( clip );
					actions[ clip.name ] = action;

					if ( states.indexOf( clip.name ) >= 0 ) {

						action.clampWhenFinished = true;
						action.loop = THREE.LoopOnce;
					}
				}

				// states
				var statesFolder = gui.addFolder( 'States' );
				var clipCtrl = statesFolder.add( currentDropdownSelection, 'state' ).options( states );
				clipCtrl.onChange( function () {
					fadeToAction( currentDropdownSelection.state, 0.5 );
				} );

				statesFolder.open();

				activeAction = actions[ 'idle' ];
				activeAction.setLoop(1)
				activeAction.play();
			}

			function fadeToAction( name, duration, loop = false, timeScale = 1 ) {

				previousAction = activeAction;
				activeAction = actions[ name ];

				if ( previousAction !== activeAction ) {

					previousAction.fadeOut( duration );

				}

				activeAction
					.reset()
					.setLoop( loop ? THREE.LoopRepeat : THREE.LoopOnce )
					.setEffectiveTimeScale( timeScale )
					.setEffectiveWeight( 1 )
					.fadeIn( duration )
					.play();
			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function printOut() {
				console.log(camera);
				console.log(camera.getWorldDirection());
			}

			function animate() {

				var dt = clock.getDelta();

				if ( mixer ) mixer.update( dt );

				requestAnimationFrame( animate );
				render();
				// stats.update();

			}
			
			function render() {
				evaluateState();
				if (previousState != state) {
					changeState();
					previousState = state;
				}
				if (activeAction) {
					if (!activeAction.isRunning()) {
						startIdleAnimation(state);
					}
				}
				renderer.render(scene, camera);
			}

			function startIdleAnimation(state, transitionDuration, speed) {
				var animationName = randomArrayElement(stateIdleAnimations[state]);
				// console.log("idle: " + animationName);
				fadeToAction(animationName, transitionDuration, true, speed);
			}

			function changeState () {
				switch (state) {
					case 0: 
						break; 
					case 1:
						console.log("state 1 reached");
						startIdleAnimation(state, 0.5, 1);
						break; 
					case 2:
						console.log("state 2 reached");
						break; 
					case 3: 
						console.log("state 3 reached");
						break; 
					default: 
						break; 
				}
			}

			function randomArrayElement(items) {
				return items[Math.floor(Math.random()*items.length)];
			}

			function touchIntersectsWithSnail(ev) {
				
				var mouse = new THREE.Vector2((ev.center.x /  renderer.domElement.clientWidth ) * 2 - 1, - (ev.center.y /  renderer.domElement.clientHeight ) * 2 + 1);
				
				raycaster.setFromCamera(mouse, camera);

				var intersects = raycaster.intersectObject(raycastTarget, true);
				// console.log(intersects);
				if (intersects.length > 0) {
					return true;
				}
				return false;
			}

			function handleTouchEvent(ev) {
				// console.log(ev.type);

				if (touchIntersectsWithSnail(ev)) {
					// fadeToAction("dance", 0.5, false, 1);
					// audioTest.load();
					// audioTest.play();
					stateCounter += interactionPoints[ev.type]
					console.log(stateCounter);
				}
			}


            function addTouchEventListeners() {
                    var region = container;
					var detector = new Hammer(region);
					
					var singleTap = new Hammer.Tap({ event: 'tap' });
					var doubleTap = new Hammer.Tap({ event: 'doubletap', taps: 2, interval: 500, posThreshold: 30 });
					detector.add([doubleTap, singleTap]);
					doubleTap.recognizeWith(singleTap);
					singleTap.requireFailure(doubleTap);

					var swipe = new Hammer.Swipe({ event:'swipe', pointers: 1, velocity: 0.25, threshold: 10, direction: Hammer.DIRECTION_ALL });
					var pinch = new Hammer.Pinch({event:'pinch', threshold: 0 });
					detector.add(pinch);
					detector.add(swipe);
					detector.add(new Hammer.Pan({threshold: 70 }).requireFailure([pinch, swipe]));
                    detector.on("tap press swipe doubletap pinchend panend", handleTouchEvent);
                };

		</script>

	</body>
</html>
