<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Interplanetary Flirtation Device - Chloê Langford</title>
		<meta charset="utf-8">
		<link rel="icon" href="images/snail_small.png" type="image/png"> 
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />         
		<meta name="description" content="A device for communicating via touch with extraterrestrial beings. Using a snail as an interface, the user can encode their messages to aliens in taps, pinches, presses and swipes.">         
		<meta name="author" content="Chloê Langford">         
		<meta name="viewport" content="width=device-width, initial-scale=1.0">        
		<meta name="keywords" content="experimental art, media art, digital art, new media, net art, artgames, videogame, indie games, alien, extraterrestrial, Chloê Langford, tactile, mobile games, web-based art, snail, digital culture">        
		<!-- Twitter Card data -->         
		<meta name="twitter:card" content="summary">        
		<meta name="twitter:site" content="@greenred123">         
		<meta name="twitter:title" content="Interplanetary Flirtation Device v2.0">         
		<meta name="twitter:description" content="A device for communicating via touch with extraterrestrial beings. Using a snail as an interface, the user can encode their messages to aliens in taps, pinches, presses and swipes.">                 
		<meta name="twitter:creator" content="@greenred123">        
		<!-- Twitter Summary card images must be at least 120x120px -->         
		<meta name="twitter:image" content="https://ifd.co-ordinat.es/images/snail.jpg">         
		<!-- Open Graph data -->         
		<meta property="og:title" content="Interplanetary Flirtation Device" />         
		<meta property="og:type" content="article" />         
		<meta property="og:url" content="https://ifd.co-ordinat.es/" />         
		<meta property="og:image" content="https://ifd.co-ordinat.es/images/snail.jpg" />         
		<meta property="og:description" content="A device for communicating via touch with extraterrestrial beings. Using a snail as an interface, the user can encode their messages to aliens in taps, pinches, presses and swipes.">                 
		<meta property="og:site_name" content="Interplanetary Flirtation Device" />
		<style>
			body {
				color: darkblue;
				font-family: Helvetica;
			}

			a {
				color: #2fa1d6;
			}
			p {
				max-width: 600px;
				margin-left: auto;
				margin-right: auto;
				padding: 0 2em;
			}


            .intro-text {
				text-align: center;
				margin: 5% auto 0 auto;
                padding: 2.5%;
                font-size: x-large;
                /* max-width: 600px; */
			}

			.text-dialogs {
					width: 100%;
				height: 100%;
				position: absolute;
				top: 0;
				left: 0;
                background: url(models/gradient-orange-green.png) no-repeat center center fixed;
                -webkit-background-size: cover;
                -moz-background-size: cover;
                -o-background-size: cover;
                background-size: cover;
                background-color: #b9e000;
				display: table;
                z-index: 5;
			}

			.inner {
				display: table-cell;
				vertical-align: middle;
                text-align: center;
			}   
            button {
                font-size: x-large;
                padding: 5px 5px 5px 5px;
                background-color: transparent;
                border: 2px solid darkblue;
				font-style: italic;
				color: darkblue;
                min-width: 30px;
            }

			#close {
				position: absolute;
                top: 1%;
                right: 2%;
                font-size: x-large;
                font-style: italic;
                padding: 0;
				margin: 0;
				color: darkblue;
				font-weight: bolder;
            }

            #webglmessage {
                z-index: 6;
                font-family: monospace;
                font-size: 13px;
                font-weight: normal;
                text-align: center;
                background: rgb(255, 255, 255);
                color: rgb(0, 0, 0);
                width: 100%;
                position: absolute;
                top: 0;
                height: 100%;
            }
            .zoom {
                color: darkblue; 
                border-color: darkblue;
            }
            a {
                text-decoration: underline; 
				font-style: italic;
                color: darkblue; 
				
            }
		</style>
	</head>

	<body style="margin:0; padding: 0;">
		<!-- <button id="button">debug</button> -->
		<!-- <a href="files/a-flipper-strokes.pdf" target="_blank">download test</a> -->
        <div id="intro" class="text-dialogs">
            <p id="close">x</p>
            <div class="inner">
        
                <div class="intro-text" >
                    <p id="text">Hi, welcome to the Interplanetary Flirtation Device - a telecommunication system that allows you to communicate with
                    extra-terrestrials using touch.</p>
                    <button id="next">Next</button>
                </div>
                
            </div>
		</div>
		<div id="end" style="display:none;" class="text-dialogs">
			<div class="inner">
				<div class="intro-text">
					<p>Your message has been encoded and transmitted to your correspondent and you have received a response message.</p>
					<a id="download" href="" target="_blank"><button>Download Response</button></a>
				</div>
		
			</div>
		</div>
        <!-- <div style="position: absolute; bottom: 5%; width: 100%; text-align: center;"><button class="zoom" id="zoomin">+</button><button class="zoom" id="zoomout">-</button></div> -->
        <div id="container" style="margin:0; padding: 0;"></div>

        <script src="lib/hammerjs/hammer.min.js"></script>

		<script type="module">

			import * as THREE from './lib/three.module.js';

			import Stats from './lib/stats.module.js';
			import { GUI } from './lib/dat.gui.module.js';

            import { GLTFLoader } from './lib/GLTFLoader.js';
            import {WEBGL} from './lib/webgl.js';

			var container, stats, clock, gui, mixer, actions, activeAction, previousAction, startElement;
			var camera, scene, renderer, sceneParts, face, controls, raycastTarget, raycaster;
            var detector, finished, ending, download, currentAudio, test, audioLoader;
            var audioInitialised = false;
			var finishedTimer = 0;
			var currentDropdownSelection = { state: 'idle' };
			var audio = {};;
			var state = 0;
			var previousState = 0;
			var stateCounter = 0;
			var fileNames = [
					"a-flipper-strokes.pdf",        "pink-swan.pdf",
					"alien-rot.pdf",                "pink-tusk.pdf",
					"anise-creature.pdf",           "receptor-flush.pdf",
					"anise-milch.pdf",              "room-womb.pdf",
					"avalanche-of-sensation.pdf",   "sea-eyes.pdf",
					"bleached-horizon.pdf",         "secret-fruits.pdf",
					"brain-noodles.pdf",            "sheep-skins-oyster-shells.pdf",
					"cockroach-innards.pdf",        "shoulder-solder.pdf",
					"cold-hard-love.pdf",           "smell-sweat.pdf",
					"concrete-ankle-bracelet.pdf",  "snail-sex.pdf",
					"core-stone.pdf",               "snail-stomach.pdf",
					"dove-pigeon-rat.pdf",          "spider-shore.pdf",
					"each-keystroke.pdf",           "spiders-tongue.pdf",
					"flexible-bodies.pdf",          "stash-rash.pdf",
					"floppy-hearts.pdf",            "steam-staub.pdf",
					"goose-cracklings.pdf",         "sternum-butter-sun.pdf",
					"hair-hide.pdf",                "sunstalgia-moonstalgia.pdf",
					"haunch-hunch.pdf",             "swan-nipple.pdf",
					"hedgehog-crackling.pdf",       "sweats-scrapes.pdf",
					"hot-rot.pdf",                  "tasteless-liquid.pdf",
					"iteration-reflection.pdf",     "teradactyl-oyster.pdf",
					"keta-nettle.pdf",              "the-procedure.pdf",
					"landscape-of-dough.pdf",       "thinking-about.pdf",
					"list.pdf",                     "thrust-rot.pdf",
					"lubehips.pdf",                 "tickle-your-snail.pdf",
					"metallic-sage.pdf",            "transform-escape.pdf",
					"michelin-genitals.pdf",        "tusk.pdf",
					"moon-puke-baby.pdf",           "twists-thrusts.pdf",
					"muschel-slice.pdf",            "velvet-condom.pdf",
					"noxious-organ.pdf",            "written-sweat.pdf",
					"pale-blue-foam.pdf",           "x-fingers.pdf"
		]
			var interactionAnimations = {
				"panend": ["shudder", "move_head_up"],
				"swipe": ["cramp"],
				"tap": ["antennae-twitch", "tail_thump"], 
				"doubletap": ["bend-slightly-forward"],
				"pinchend": ["tail_wag"], 
				"press": ["dance"]
			};

			var stateIdleAnimations =  [
				["idle"], //state 0
				["antennae-twitch", "tail_wag"], //state 1
				["shudder"], //state 2
				["dance" ], //state 3
				["convulse"] //state 4
			];
			var stateEffects = [
				[], // state 0
				[], // state 1
				[], // state 2
				[], // state 3
				[] //state 4
			];
			var interactionPoints = {
				"panend": 3,
				"swipe": 5,
				"tap": 1, 
				"doubletap": 2,
				"pinchend": 3, 
				"press": 2
			}
            var currentText = -1;
            var texts = [
                'It was made by <a href="https://co-ordinat.es" target="_blank">Chloê Langford</a> as part of the <a href="http://www.welcometomyhomepage.net/about-residency" target="_blank">Welcome to My Homepage residency</a>.',
                'If you are using a desktop computer, please visit this page on a mobile device for the full experience. <br><br> <img style="width:20vh;height:20vh;" src="images/qr-code.png"> <br><br> https://ifd.co-ordinat.es',
                'Please turn up your volume.',
                'In order to communicate with extra-terrestrials using this experimental method, you are required to tap, press, pinch and stroke a rare variety of snail.',
                'When your gestures have been successfully encoded, the snail will peak in stimulation levels and transmit your message. You should receive a response from your correspondent shortly thereafter.', 
            ]

			var text;
			
			if (!WEBGL.isWebGLAvailable()) {
                var warning = WEBGL.getWebGLErrorMessage();
                document.body.appendChild(warning);
			} else 
			{
				init();
            	animate();
			}

			function init() {      
				container = document.getElementById('container');
				ending = document.getElementById('end');
				text = document.getElementById('text');
                download = document.getElementById('download');
				

				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.25, 100 );
				camera.position.set( -0.923, 0.5, 5.52 );
                camera.lookAt(0,0.25,0);

                // audio
                var audioLoader = new THREE.AudioLoader();

                var listener = new THREE.AudioListener();
                camera.add(listener);

				scene = new THREE.Scene();
				var texture = new THREE.TextureLoader().load( "models/gradient-orange-green.png" );
				scene.background = texture;

				clock = new THREE.Clock();

				// lights

				var light = new THREE.HemisphereLight( 0xffffff, 0x444444 );
				light.position.set( 0, 20, 0 );
				scene.add( light );

				light = new THREE.DirectionalLight( 0xffffff, 0.5);
				light.position.set( 0, 20, 10 );
				scene.add( light );


				var loader = new GLTFLoader();
				loader.load( 'models/snail_ani.glb', function ( gltf ) {

                    sceneParts = gltf.scene;
                    scene.position.set( 0.25, 0, 0);
                    scene.add( sceneParts );
					raycastTarget = sceneParts['children'][4];
					raycastTarget.material.transparent = true;
					raycastTarget.material.opacity = 0;

                    // console.log(raycastTarget);
                    // console.log(gltf.animations)

					createGUI( sceneParts, gltf.animations );
				}, undefined, function ( e ) {
					console.error( e );
				} );


                raycaster = new THREE.Raycaster();

				renderer = new THREE.WebGLRenderer( { antialias: true } );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.outputEncoding = THREE.sRGBEncoding;
                container.appendChild( renderer.domElement );

				window.addEventListener( 'resize', onWindowResize, false );
				// document.getElementById("button").addEventListener('click', printOut);
				// document.getElementById("zoomin").addEventListener('click', zoomIn);
                // document.getElementById("zoomout").addEventListener('click', zoomOut);
                document.getElementById("close").addEventListener('click', closeOverlay);
                document.getElementById("next").addEventListener('click', next);
                  
				// stats
				// stats = new Stats();
				// container.appendChild( stats.dom );
            }

            function initialiseAudio(){
                if (!audioInitialised) {
                    var audioLoader = new THREE.AudioLoader();

                    var listener = new THREE.AudioListener();
                    camera.add(listener);

                    var creature2 = new THREE.PositionalAudio(listener);
                    var exotic2 = new THREE.PositionalAudio(listener);
                    var cranes = new THREE.PositionalAudio(listener);
                    var wetGulps = new THREE.PositionalAudio(listener);
                    var creatureVoice = new THREE.PositionalAudio(listener);
                    var exotic1 = new THREE.PositionalAudio(listener);
                    var impact = new THREE.PositionalAudio(listener);
                    var snarl = new THREE.PositionalAudio(listener);
                    var longGulps = new THREE.PositionalAudio(listener);

                    audioLoader.load("audio/creature2.mp3", function (buffer) {
                        audio['shudder'] = creature2.setBuffer(buffer);
                    });
                    audioLoader.load("audio/exotic-creature-trimmed-2.mp3", function (buffer) {
                        audio['move_head_up'] = exotic2.setBuffer(buffer);
                    });
                    audioLoader.load("audio/cranes_4.mp3", function (buffer) {
                        audio['cramp'] = cranes.setBuffer(buffer);
                    });
                    audioLoader.load("audio/clean_wet_gulps.mp3", function (buffer) {
                        audio['antennae-twitch'] = wetGulps.setBuffer(buffer);
                    });
                    audioLoader.load("audio/creature_voice.mp3", function (buffer) {
                        audio['tail_thump'] = creatureVoice.setBuffer(buffer);
                    });
                    audioLoader.load("audio/exotic-creature-trimmed-1.mp3", function (buffer) {
                        audio['bend-slightly-forward'] = exotic1.setBuffer(buffer);
                    });
                    audioLoader.load("audio/impact_wet.mp3", function (buffer) {
                        audio['tail_wag'] = impact.setBuffer(buffer);
                    });
                    audioLoader.load("audio/snarl-trimmed-1.mp3", function (buffer) {
                        audio['dance'] = snarl.setBuffer(buffer);
                    });
                    audioLoader.load("audio/clean_wet_gulps_long.mp3", function (buffer) {
                        audio['convulse'] = longGulps.setBuffer(buffer);
                        audio['convulse'].setLoop(true);
                    });
                    audioInitialised = true;

                }
            }

            function next() {
                initialiseAudio();
                
                currentText ++;
                if (currentText >= 5) {
                    closeOverlay();
                }
                text.innerHTML = texts[currentText];
            };

            function closeOverlay() {
                initialiseAudio();
                var intro = document.getElementById('intro');
                intro.parentNode.removeChild(intro);
                addTouchEventListeners();
            };
            
            function zoomIn() {
                camera.zoom += 0.2;
                camera.updateProjectionMatrix();
            };

            function zoomOut() {
                camera.zoom -= 0.2;
                camera.updateProjectionMatrix();

            }

			function evaluateState() {
				if(stateCounter < 61) {
					state = 0;
				} else if (stateCounter < 121) {
					state = 1;
				} else if (stateCounter < 181) {
					state = 1.5;
				} else if (stateCounter < 221) {
					state = 2;
				} else if (stateCounter < 261) {
					state = 2.5;
				} else if (stateCounter < 391) {
					state = 3;
				} else if (stateCounter < 441) {
					state = 3.5;
				} else {
					state = 4;
				}
			}

			function createGUI( sceneParts, animations ) {

				var animationStates = [ 
					'cramp',
					'antennae-twitch',
					'bend-slightly-forward',
					'convulse', 
					'dance', 
					'idle', 
					'move_head_up', 
					'shudder', 
					'tail_thump', 
					'tail_wag'
				 ];

				gui = new GUI();

				mixer = new THREE.AnimationMixer( sceneParts );

				actions = {};

				for ( var i = 0; i < animations.length; i ++ ) {

					var clip = animations[ i ];
					var action = mixer.clipAction( clip );
					actions[ clip.name ] = action;

					if ( animationStates.indexOf( clip.name ) >= 0 ) {

						action.clampWhenFinished = true;
						action.loop = THREE.LoopOnce;
					}
				}

				// animationState
				var animationStateFolder = gui.addFolder( 'animationState' );
				var clipCtrl = animationStateFolder.add( currentDropdownSelection, 'state' ).options( animationStates );
				clipCtrl.onChange( function () {
					fadeToAction( currentDropdownSelection.state, 0.5 );
				} );

				animationStateFolder.open();

				activeAction = actions[ 'idle' ];
				activeAction.setLoop(1)
				activeAction.play();
			}

			function fadeToAction( name, duration, loop = false, timeScale = 1 ) {
				
				previousAction = activeAction;
				activeAction = actions[ name ];
				// console.log(actions);
				// console.log(name);
				if (previousAction) {
					if ( previousAction !== activeAction ) {

						previousAction.fadeOut( duration );
					}
				}

				activeAction
					.reset()
					.setLoop( loop ? THREE.LoopRepeat : THREE.LoopOnce )
					.setEffectiveTimeScale( timeScale )
					.setEffectiveWeight( 1 )
					.fadeIn( duration )
					.play();
			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function printOut() {
				console.log(camera);
				console.log(camera.getWorldDirection());
			}

			function animate() {

				var dt = clock.getDelta();

				if ( mixer ) mixer.update( dt );

				requestAnimationFrame( animate );
				render();
				// stats.update();

			}
			
			function render() {
				// console.log(finished);
				
				if (finishedTimer >= 0.1) {
					if (finished) {
                        audio['convulse'].stop() 
						download.href = "/files/" + randomArrayElement(fileNames);
						end.style = "display: table;"
						finished = false;
					}
				} else {
					if (finished) {
						console.log(finishedTimer);
						finishedTimer += clock.getDelta();
					} else {
						evaluateState();
						if (previousState != state) {
							changeState();
							previousState = state;
						}
					}

					if (activeAction) {
						if (!activeAction.isRunning()) {
							var flooredState = Math.floor(state);
							var speed = state - flooredState;
							startIdleAnimation(state = flooredState, speed = speed);
						}
					}
					renderer.render(scene, camera);
				}
			}

			function selectRandomText() {

			}

			function startIdleAnimation(state, transitionDuration, speed) {
				var animationName = randomArrayElement(stateIdleAnimations[state]);
				// console.log("idle: " + animationName);
				fadeToAction(animationName, transitionDuration, true, speed);
			}

			function changeState () {
				switch (state) {
					case 0: 
						break; 
					case 1:
						console.log("state 1 reached");
						startIdleAnimation(state, 0.5, 1);
						break; 
					case 1.5:
						console.log("state 1.5 reached");
						startIdleAnimation(Math.floor(state), 0.5, 1.5);
						break; 
					case 2:
						console.log("state 2 reached");
						startIdleAnimation(state, 0.5, 1);
						break; 
					case 2.5:
						console.log("state 2.5 reached");
						startIdleAnimation(Math.floor(state), 0.5, 1.5);
						break; 
					case 3: 
						console.log("state 3 reached");
						startIdleAnimation(state, 0.3, 1);
						break;
					case 3.5:
						console.log("state 3.5 reached");
						startIdleAnimation(Math.floor(state), 0.3, 1.5);
						break; 
					case 4:
						console.log("state 4 reached");
						finished = true;
						removeTouchEventListeners();
                        startIdleAnimation(state, 0.1, 1);
                        audio['convulse'].play();
						break;
					default: 
						break; 
				}
			}

			function randomArrayElement(items) {
				return items[Math.floor(Math.random()*items.length)];
			}

			function touchIntersectsWithSnail(ev) {
				
				var mouse = new THREE.Vector2((ev.center.x /  renderer.domElement.clientWidth ) * 2 - 1, - (ev.center.y /  renderer.domElement.clientHeight ) * 2 + 1);
				
				raycaster.setFromCamera(mouse, camera);

				var intersects = raycaster.intersectObject(raycastTarget, true);
				// console.log(intersects);
				if (intersects.length > 0) {
					return true;
				}
				return false;
			}

			function handleTouchEvent(ev) {
                // console.log(ev.type);
				if (state < 3 && ev.type == "swipe") {
					return;
                }
                var aniName = randomArrayElement(interactionAnimations[ev.type]);
                // currentAudio = audio[aniName];
                // currentAudio.load();
                
				if (touchIntersectsWithSnail(ev)) {
                    // console.log(aniName);
                    // currentAudio.play();
                    audio[aniName].play();
					fadeToAction(aniName, 0.1, false, 1);
					stateCounter += interactionPoints[ev.type]
					console.log(stateCounter);
				}
			}


            function addTouchEventListeners() {
                    var region = container;
					detector = new Hammer(region);
					
					var singleTap = new Hammer.Tap({ event: 'tap' });
					var doubleTap = new Hammer.Tap({ event: 'doubletap', taps: 2, interval: 500, posThreshold: 30 });
					detector.add([doubleTap, singleTap]);
					doubleTap.recognizeWith(singleTap);
					singleTap.requireFailure(doubleTap);

					var swipe = new Hammer.Swipe({ event:'swipe', pointers: 1, velocity: 0.25, threshold: 10, direction: Hammer.DIRECTION_ALL });
					var pinch = new Hammer.Pinch({event:'pinch', threshold: 0 });
					detector.add(pinch);
					detector.add(swipe);
					detector.add(new Hammer.Pan({threshold: 70 }).requireFailure([pinch, swipe]));
                    detector.on("tap press swipe doubletap pinchend panend", handleTouchEvent);
			};
			
			function removeTouchEventListeners() {
				detector.destroy();
			}

		</script>

	</body>
</html>
